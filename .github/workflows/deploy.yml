- name: Deploy to production server
  uses: appleboy/ssh-action@v1.1.0
  with:
    host: ${{ secrets.SERVER_HOST }}
    username: ${{ secrets.SERVER_USER }}
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    port: ${{ secrets.SSH_PORT }}
    script: |
      echo "ğŸš€ Starting deployment on $HOSTNAME"

      cd /var/www/stee/app || exit 1

      echo "ğŸ“¥ Pulling latest code..."
      if [ -d .git ]; then
        git fetch origin main
        git reset --hard origin/main
      else
        echo "âš ï¸  No .git folder found, skipping git pull."
      fi

      echo "ğŸ³ Rebuilding Docker containers..."
      cd /var/www/stee
      docker compose down
      docker compose up -d --build

      echo "âš™ï¸  Running migrations and collectstatic..."
      docker exec stee-web python manage.py migrate --noinput || true
      docker exec stee-web python manage.py collectstatic --noinput || true

      echo "âœ… Deployment complete!"
